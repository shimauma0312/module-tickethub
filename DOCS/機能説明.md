# TicketHub管理システム 実装機能説明書

## 1. 概要

TicketHubは、GitHubライクなチケット管理システムで、Issue・Discussion管理、コメント、ラベル、マイルストーン、アサイン機能などを備えたRESTful APIを提供します。本ドキュメントでは、実装された各機能について説明します。

## 2. アーキテクチャ

### 2.1 システム構成

```
Client <---> Gin Web Server <---> Repository Layer <---> Database
```

### 2.2 主要コンポーネント

- **APIハンドラ**: クライアントからのリクエストを処理し、適切なレスポンスを返します
- **リポジトリレイヤー**: データベースとのやり取りを抽象化し、データの永続化を担当
- **モデル**: アプリケーションのデータ構造を定義
- **サービス**: 認証やビジネスロジックを提供
- **ミドルウェア**: リクエスト処理の前後で共通処理を実行（認証、権限チェックなど）

### 2.3 使用技術

- **言語**: Go 1.22
- **Webフレームワーク**: Gin
- **データベース**: 抽象化レイヤー、GormでRDBの柔軟な切り替え可能
- **認証**: JWT（JSON Web Token）
- **ドキュメント生成**: Swagger/OpenAPI
- **Markdownレンダリング**: Goldmark

## 3. 実装された機能

### 3.1 Issue管理

Issueは、バグ報告や機能要望などを管理するためのチケットです。

#### 主な機能

- **Issue一覧取得**: ページング、フィルタリング（ステータス、ラベル、担当者、マイルストーン）
- **Issue詳細取得**: 特定のIssueの詳細情報を取得
- **Issue作成**: タイトル、説明、ラベル、担当者、マイルストーン情報を指定して作成
- **Issue更新**: 既存のIssueの情報を更新
- **Issue削除**: Issueを削除
- **ステータス更新**: Issueのステータスをopenまたはclosedに変更
- **ドラフト管理**: 下書き状態の設定・解除
- **検索機能**: タイトルや本文などからIssueを検索

#### 実装ファイル
- `api/issue_handler.go`: Issueに関するAPIエンドポイント処理
- `models/issue.go`: Issueのデータモデル定義

### 3.2 Discussion管理

Discussionは、トピックベースの議論のためのチケットです。Issue以外の一般的な話題を扱います。

#### 主な機能

- **Discussion一覧取得**: ページング、フィルタリング（ステータス、カテゴリ、ラベル）
- **Discussion詳細取得**: 特定のDiscussionの詳細情報を取得
- **Discussion作成**: タイトル、内容、カテゴリ、ラベル情報を指定して作成
- **Discussion更新**: 既存のDiscussionの情報を更新
- **Discussion削除**: Discussionを削除
- **ステータス更新**: Discussionのステータスをopenまたはclosedまたはansweredに変更
- **ドラフト管理**: 下書き状態の設定・解除
- **検索機能**: タイトルや本文などからDiscussionを検索

#### 実装ファイル
- `api/discussion_handler.go`: Discussionに関するAPIエンドポイント処理
- `models/discussion.go`: Discussionのデータモデル定義

### 3.3 コメント機能

IssueやDiscussionに対するコメントと、スレッド型の返信コメント機能を提供します。

#### 主な機能

- **コメント一覧取得**: IssueまたはDiscussionに紐づくコメントの一覧を取得
- **コメント詳細取得**: 特定のコメントの詳細情報を取得
- **コメント作成**: IssueやDiscussionに対するコメントを作成
- **返信コメント作成**: 既存のコメントに対する返信を作成
- **コメント更新**: 既存のコメントの内容を更新
- **コメント削除**: コメントを削除
- **返信一覧取得**: 特定のコメントに対する返信の一覧を取得

#### 実装ファイル
- `api/comment_handler.go`: コメントに関するAPIエンドポイント処理
- `models/comment.go`: コメントのデータモデル定義

### 3.4 ラベル管理

IssueやDiscussionを分類するためのラベル機能を提供します。

#### 主な機能

- **ラベル一覧取得**: システムに登録されているラベルの一覧を取得
- **ラベル詳細取得**: 特定のラベルの詳細情報を取得
- **ラベル作成**: 新しいラベルを作成（管理者のみ）
- **ラベル更新**: 既存のラベルの情報を更新（管理者のみ）
- **ラベル削除**: ラベルを削除（管理者のみ）

#### 実装ファイル
- `api/label_handler.go`: ラベルに関するAPIエンドポイント処理
- `models/label.go`: ラベルのデータモデル定義

### 3.5 マイルストーン管理

Issue管理のためのマイルストーン（目標）機能を提供します。

#### 主な機能

- **マイルストーン一覧取得**: システムに登録されているマイルストーンの一覧を取得
- **マイルストーン詳細取得**: 特定のマイルストーンの詳細情報を取得
- **マイルストーン作成**: 新しいマイルストーンを作成
- **マイルストーン更新**: 既存のマイルストーンの情報を更新
- **マイルストーン削除**: マイルストーンを削除
- **ステータス更新**: マイルストーンのステータスを変更

#### 実装ファイル
- `api/milestone_handler.go`: マイルストーンに関するAPIエンドポイント処理
- `models/milestone.go`: マイルストーンのデータモデル定義

### 3.6 アサイン機能

Issueに担当者を割り当てる機能を提供します。

#### 主な機能

- **Issue担当者設定**: Issueに担当者を割り当て
- **Issue担当者削除**: Issueから担当者の割り当てを解除

#### 実装ファイル
- `api/assignment_handler.go`: アサインに関するAPIエンドポイント処理

### 3.7 Markdownレンダリング

Markdown形式のテキストをHTML形式に変換する機能を提供します。

#### 主な機能

- **Markdownレンダリング（JSON）**: Markdown形式のテキストをHTMLに変換し、JSON形式で返却
- **Markdownレンダリング（HTML）**: Markdown形式のテキストをHTMLに変換し、生のHTMLとして返却

#### 実装ファイル
- `api/markdown_handler.go`: Markdownレンダリングに関するAPIエンドポイント処理

### 3.8 ドラフト管理

Issue・Discussionの下書き保存と管理機能を提供します。

#### 主な機能

- **ドラフト一覧取得**: ユーザーが保存した下書きの一覧を取得
- **Issueドラフト保存**: Issueの下書きを保存
- **Discussionドラフト保存**: Discussionの下書きを保存

#### 実装ファイル
- `api/draft_handler.go`: ドラフト管理に関するAPIエンドポイント処理

### 3.9 認証・認可

ユーザー認証と権限管理の機能を提供します。

#### 主な機能

- **ユーザー登録**: 新規ユーザーの登録
- **ログイン**: ユーザー認証とアクセストークンの発行
- **トークンリフレッシュ**: 有効期限切れのアクセストークンを更新
- **ログアウト**: ユーザーセッションの終了
- **パスワードリセット**: パスワードを忘れた場合のリセット機能
- **パスワード変更**: ログイン中のユーザーがパスワードを変更
- **認証ミドルウェア**: 保護されたAPIエンドポイントへのアクセス制御
- **管理者権限ミドルウェア**: 管理者専用機能へのアクセス制御

#### 実装ファイル
- `api/auth_handler.go`: 認証に関するAPIエンドポイント処理
- `api/middleware.go`: 認証・権限チェックミドルウェア
- `services/auth_service.go`: 認証ロジックの実装

### 3.10 検索機能

IssueとCommentを横断して高速かつ柔軟な検索を行うための全文検索システムを提供します。

#### 主な機能

- **横断検索**: Issueのタイトル・本文、およびCommentの本文を対象に検索を実行します。
- **キーワード検索**: 指定されたキーワードに基づいてコンテンツを検索します。
- **フィルタリング**: 以下の条件で検索結果を絞り込めます。
    - ラベル: 特定のラベルが付与されたIssueを対象とします。
    - ステータス: Issueのステータス（open/closed）でフィルタリングします。
    - 担当者: 特定の担当者が割り当てられたIssueを検索します。
    - 作成者: 特定のユーザーが作成したIssueやCommentを検索します。
- **ランキング**: FTS5 (SQLite Full-Text Search) のランキングアルゴリズムに基づき、関連性の高い順に結果を表示します。
- **スニペット表示**: 検索キーワードを含む本文の断片（スニペット）を結果に表示します。
- **ハイライト**: 検索結果の本文やタイトル内で、検索キーワードをハイライト表示します。
- **インデックス自動更新**: IssueやCommentが作成・更新されると、検索インデックスは自動的に更新されます。
- **インデックス再構築**: 管理者向けに、手動で検索インデックス全体を再構築する機能を提供します。

#### 検索対象フィールド

- **Issue**: `title` (タイトル), `body` (本文)
- **Comment**: `body` (本文)

#### パフォーマンス

- SQLiteのFTS5拡張機能を利用し、大量データに対しても高速な検索（目標1秒以内）を実現します。
- 効率的なインデックス管理により、常に最新のデータに基づいた検索が可能です。

#### 実装ファイル

- `api/search_handler.go`: 検索APIリクエストの処理
- `services/search_service.go`: 検索サービスのインターフェース定義
- `services/search_service_impl.go`: 検索サービスの具体的な実装（インデックス作成、検索ロジック、フィルタリング、ランキング処理など）
- `models/search.go`: 検索クエリ、検索結果、インデックス構造体の定義

## 4. API設計

### 4.1 RESTful設計原則

- **リソース指向**: URIがリソース（名詞）を表し、HTTPメソッドが操作を表す
- **ステートレス**: 各リクエストは独立しており、セッション状態に依存しない
- **適切なHTTPメソッド**: GET（取得）、POST（作成）、PUT（更新）、DELETE（削除）、PATCH（部分更新）
- **適切なHTTPステータスコード**: 200（成功）、201（作成成功）、400（不正リクエスト）、401（認証失敗）、403（権限なし）、404（リソースなし）、500（サーバーエラー）など

### 4.2 エンドポイント構造

基本的なエンドポイント構造は以下の通りです：

- `/api/auth/*`: 認証関連
- `/api/v1/issues/*`: Issue管理
- `/api/v1/discussions/*`: Discussion管理
- `/api/v1/comments/*`: コメント管理
- `/api/v1/labels/*`: ラベル管理
- `/api/v1/milestones/*`: マイルストーン管理
- `/api/v1/markdown/*`: Markdownレンダリング
- `/api/v1/drafts/*`: ドラフト管理
- `/api/v1/search/*`: 検索機能

### 4.3 APIドキュメント

SwaggerでAPIドキュメントが自動生成されます。URLは以下の通りです：

- `/swagger/index.html`: Swagger UI（API仕様書）

## 5. セキュリティ対策

### 5.1 認証

- **JWT認証**: JSON Web Tokenを使用したセキュアな認証
- **トークン有効期限**: アクセストークンの短期有効期限と、リフレッシュトークンによる更新メカニズム
- **セキュアなパスワード管理**: パスワードのハッシュ化保存

### 5.2 認可

- **権限チェック**: 適切な権限を持つユーザーのみが特定の操作を実行可能
- **管理者権限**: 一部の機能（ラベル管理など）は管理者のみがアクセス可能

### 5.3 その他のセキュリティ対策

- **CORS設定**: クロスオリジンリクエストの適切な制御
- **CSRF対策**: クロスサイトリクエストフォージェリ対策トークンの提供
- **エラーハンドリング**: セキュリティ情報を漏らさない適切なエラーレスポンス

## 6. エラー処理

### 6.1 エラーレスポンス形式

エラー発生時は以下の形式でレスポンスを返します：

```json
{
  "error": "エラーメッセージ"
}
```

### 6.2 エラーログ

重要なエラーはサーバーログに記録され、デバッグと問題解決に役立てられます。

## 7. パフォーマンス対策

### 7.1 データベースアクセス最適化

- **ページネーション**: 大量のデータを扱う場合のパフォーマンス向上
- **インデックス**: 適切なデータベースインデックスによる検索効率化

### 7.2 キャッシュ戦略

- **オプショナルRedisキャッシュ**: 環境設定によりRedisキャッシュを有効化可能

## 8. 拡張性

### 8.1 リポジトリパターン

データベースアクセスを抽象化し、異なるデータベースへの切り替えを容易にします。

### 8.2 モジュール化

機能ごとにモジュール化されたコード構造により、新機能の追加や既存機能の変更が容易です。

## 9. 今後の拡張

以下の機能は今後の拡張として検討されています：

- **リアルタイム通知**: WebSocketを使用したリアルタイム更新
- **高度な検索機能**: 検索DSLの導入
- **SSO認証**: シングルサインオン認証の追加
- **RBAC**: ロールベースのアクセス制御
- **ファイル添付機能**: IssueやDiscussionへのファイル添付
- **Webhook**: 外部システムとの連携
- **メトリクス**: 利用統計やパフォーマンスモニタリング
